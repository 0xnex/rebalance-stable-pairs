# V1.2 Strategy Implementation Guide

## Overview
This document describes the implementation of Strategy Version 1.2 (Option A) - Three-Band Rebalancer with Contiguous Bands and Trend-Based Rebalancing.

## Implementation Status: ✅ COMPLETE

All V1.2 features have been implemented in:
- `src/strategies/three_band_rebalancer_strategy_option_2.4.1.1.ts`

---

## Key Features Implemented

### 1. Position Configuration (Option A) ✅
- **3 positions with equal capital allocation (33.33% each)**
- **Contiguous bands (no overlap)**
- **Range multipliers**: 1.0, 1.5, 2.0

```typescript
// Position layout:
Position 1 (33.33%): [p1Lower, p1Upper] - Narrow range (base × 1.0)
Position 2 (33.33%): [p1Upper, p2Upper] - Medium range (base × 1.5)
Position 3 (33.34%): [p2Upper, p3Upper] - Wide range (base × 2.0)
```

### 2. Market Indicators Integration ✅

#### Market Indicators Interface
```typescript
type MarketIndicators = {
  safetyScore: number;      // 0-100
  trendScore: number;        // 0-100
  volatilityPercent: number; // Annualized volatility %
  rsiScore?: number;         // Optional RSI
  liquidityScore?: number;   // Optional liquidity
};
```

#### API Methods
```typescript
// Update market indicators before each execution
strategy.updateMarketIndicators({
  safetyScore: 65,
  trendScore: 70,
  volatilityPercent: 45,
});

// Get current indicators
const indicators = strategy.getMarketIndicators();
```

### 3. Entry Conditions ✅

Positions are only opened when:
- **Safety Score ≥ 50**
- **Trend Score ≥ 50**

```typescript
private checkEntryConditions(): { allowed: boolean; reason: string } {
  if (safetyScore < 50) return { allowed: false, reason: "..." };
  if (trendScore < 50) return { allowed: false, reason: "..." };
  return { allowed: true, reason: "..." };
}
```

### 4. Volatility-Based Range Selection ✅

Implemented according to V1.2 table:

| Volatility Level | Range (%) | Description |
|-----------------|-----------|-------------|
| Very Low (<20%) | 7.5% | Narrow ranges for stable conditions |
| Low (20-30%) | 12.5% | Moderate ranges |
| Medium (30-50%) | 17.5% | Standard ranges |
| High (50-75%) | 25% | Wide ranges |
| Very High (>75%) | 35% | Extra wide for extreme volatility |

```typescript
private getBaseRangeFromVolatility(volatilityPercent: number): number {
  if (volatilityPercent < 20) return 0.075;
  else if (volatilityPercent < 30) return 0.125;
  else if (volatilityPercent < 50) return 0.175;
  else if (volatilityPercent < 75) return 0.25;
  else return 0.35;
}
```

### 5. Profit Calculation Methods ✅

#### Fee Earned
```typescript
private calculateFeeEarned(segment: SegmentState): bigint {
  const fees = this.manager.calculatePositionFees(segment.id);
  return fees.fee0 + fees.fee1;
}
```

#### Price Loss
```typescript
private calculatePriceLoss(segment: SegmentState): bigint {
  // V_initial = Initial_Value_A + Initial_Value_B
  const initialValue = segment.initialValueA + segment.initialValueB;
  
  // V_current = Current_Value_A + Current_Value_B
  const currentValue = currentTotals.amount0 + currentTotals.amount1;
  
  // Price loss = V_initial - V_current (when V_initial > V_current)
  return initialValue > currentValue ? initialValue - currentValue : 0n;
}
```

#### Swap Fee Estimation
```typescript
private estimateSwapFee(segment: SegmentState): bigint {
  const totalValue = totals.amount0 + totals.amount1;
  const slippageBps = BigInt(this.config.maxSwapSlippageBps);
  const swapFee = (totalValue * slippageBps) / 10_000n;
  
  // Add action costs
  return swapFee + actionCostA + actionCostB;
}
```

### 6. Rebalancing Logic ✅

#### Core Principle: Rebalance Only Farthest Out-of-Range Position

```typescript
// 1. Identify all out-of-range positions
const outOfRangePositions = this.segments.filter(seg => 
  currentTick < seg.tickLower || currentTick > seg.tickUpper
);

// 2. Find farthest position
const farthestPosition = outOfRangePositions.reduce((farthest, current) => {
  const currentDist = this.calculateDistanceFromPrice(current, currentTick);
  const farthestDist = this.calculateDistanceFromPrice(farthest, currentTick);
  return currentDist > farthestDist ? current : farthest;
});

// 3. Check profit condition
const profitCheck = this.shouldRebalancePosition(farthestPosition);
if (!profitCheck.shouldRebalance) {
  return { action: "wait", message: profitCheck.reason };
}

// 4. Rebalance only this position
this.manager.closePosition(farthestPosition.id);
const newSegment = this.openSegment(newLower, newUpper, now, allocation);
this.segments[positionIndex] = newSegment;
```

#### Trend-Based Rebalancing Conditions

```typescript
private shouldRebalancePosition(segment: SegmentState): 
  { shouldRebalance: boolean; reason: string } {
  
  const trendScore = this.marketIndicators.trendScore;
  const feeEarned = this.calculateFeeEarned(segment);
  const priceLoss = this.calculatePriceLoss(segment);
  const swapFee = this.estimateSwapFee(segment);

  if (trendScore >= 60) {
    // High Trend Score (Uptrend Market)
    // Rebalance if: Fee Earned - Price Loss - Swap Fee > 0
    const vaultProfit = feeEarned - priceLoss - swapFee;
    return {
      shouldRebalance: vaultProfit > 0n,
      reason: `High trend (${trendScore}): Vault profit ${vaultProfit} ...`,
    };
  } else {
    // Low Trend Score (Downtrend/Sideways Market)
    // Rebalance if: Fee Earned - Swap Fee > 0
    const vaultProfit = feeEarned - swapFee;
    return {
      shouldRebalance: vaultProfit > 0n,
      reason: `Low trend (${trendScore}): Vault profit ${vaultProfit} ...`,
    };
  }
}
```

### 7. Rebalancing Limits ✅

- **Maximum 1 rebalance per day** (configurable via `maxDailyRebalances`)
- **10-minute cooldown between rebalances** (configurable via `minRebalanceCooldownMs`)

```typescript
private canRebalanceToday(now: number): { allowed: boolean; reason: string } {
  const maxRebalances = this.config.maxDailyRebalances ?? 1;
  const currentDate = new Date(now).toDateString();

  // Reset counter if new day
  if (this.lastRebalanceDate !== currentDate) {
    this.dailyRebalanceCount = 0;
    this.lastRebalanceDate = currentDate;
  }

  // Check daily limit
  if (this.dailyRebalanceCount >= maxRebalances) {
    return { allowed: false, reason: "Daily limit reached" };
  }

  // Check cooldown
  const timeSinceLastRebalance = now - this.lastRebalanceTime;
  if (timeSinceLastRebalance < this.config.minRebalanceCooldownMs) {
    return { allowed: false, reason: "Cooldown active" };
  }

  return { allowed: true, reason: "OK" };
}
```

### 8. Position Tracking ✅

Each position tracks:
```typescript
type SegmentState = {
  id: string;
  type: "main" | "upper" | "lower";
  tickLower: number;
  tickUpper: number;
  lastMoved: number;
  // V1.2 tracking
  initialValueA?: bigint;
  initialValueB?: bigint;
  initialPrice?: number;
  totalFeesEarned0?: bigint;
  totalFeesEarned1?: bigint;
  capitalAllocation?: number;
};
```

### 9. Monitoring & Metrics ✅

#### Monitoring Interval
- **10 minutes** (600,000ms) per V1.2 spec

```typescript
fastIntervalMs: 600_000,  // 10 minutes
slowIntervalMs: 600_000,  // 10 minutes
```

#### Position Metrics API
```typescript
const metrics = strategy.getPositionMetrics();
// Returns array of:
// {
//   positionId: string,
//   type: "main" | "upper" | "lower",
//   tickRange: [number, number],
//   capitalAllocation: number, // percentage
//   inRange: boolean,
//   distanceFromPrice: number,
//   feeEarned: number,
//   priceLoss: number,
//   swapFee: number,
//   vaultProfit: number,
//   shouldRebalance: boolean,
//   rebalanceReason: string,
//   initialPrice: number,
//   currentPrice: number,
//   lastMoved: number,
// }
```

---

## Usage Example

### Basic Setup

```typescript
import { ThreeBandRebalancerStrategyOptionThree } from "./strategies/three_band_rebalancer_strategy_option_2.4.1.1";

// Create strategy instance
const strategy = new ThreeBandRebalancerStrategyOptionThree(
  manager,
  pool,
  {
    segmentCount: 3,
    segmentRangePercent: 0.175, // 17.5% base range (medium volatility)
    
    // V1.2 Option A specific
    maxDailyRebalances: 1,
    minRebalanceCooldownMs: 600_000, // 10 minutes
    
    // Position allocation (equal distribution)
    pos1AllocationPercent: 33.33,
    pos2AllocationPercent: 33.33,
    pos3AllocationPercent: 33.34,
    
    // Range multipliers
    baseRangeMultiplier: 1.0,
    mediumRangeMultiplier: 1.5,
    wideRangeMultiplier: 2.0,
    
    // Market indicators (initial values)
    trendScore: 50,
    safetyScore: 50,
    
    // Monitoring intervals
    fastIntervalMs: 600_000, // 10 minutes
    slowIntervalMs: 600_000, // 10 minutes
    
    // Other configs
    minSegmentDwellMs: 120_000, // 2 minutes dwell time
    minOutOfRangeMs: 120_000,   // 2 minutes out-of-range guard
  }
);
```

### Workflow

```typescript
// 1. Initialize strategy
const initResult = strategy.initialize();
console.log(initResult.message);
// "V1.2 Entry conditions not met: Safety Score 45.0 < 50"
// or
// "Seeded 3 contiguous bands (Option A: 33%/33%/34%, no overlap)"

// 2. Update market indicators periodically (before each execution)
strategy.updateMarketIndicators({
  safetyScore: 65,
  trendScore: 70,
  volatilityPercent: 45,
});

// 3. Execute strategy (every 10 minutes)
const result = strategy.execute();
console.log(result.message);
// Possible messages:
// "Waiting 598s for next check"
// "Farthest position (upper, 25 ticks away): Low trend (55): Vault profit -1500 ≤ 0..."
// "V1.2: Rebalanced farthest position (upper, 25 ticks away) to range [1200, 1250]..."

// 4. Monitor positions
const metrics = strategy.getPositionMetrics();
console.log(metrics);
// [
//   {
//     positionId: "pos_1",
//     type: "main",
//     capitalAllocation: 33.33,
//     inRange: true,
//     distanceFromPrice: 5,
//     feeEarned: 1500,
//     priceLoss: 200,
//     swapFee: 300,
//     vaultProfit: 1000,
//     shouldRebalance: true,
//     rebalanceReason: "High trend (70): Vault profit 1000 > 0...",
//     ...
//   },
//   ...
// ]
```

### Backtest Integration

```typescript
// In backtest runner:
import { ThreeBandRebalancerStrategyOptionThree } from "./strategies/...";

// Create strategy
const strategy = new ThreeBandRebalancerStrategyOptionThree(manager, pool, config);

// Initialize
strategy.initialize();

// Main loop
for (const timestamp of timestamps) {
  // 1. Fetch market indicators for this timestamp
  const indicators = await fetchMarketIndicators(timestamp);
  
  // 2. Update strategy
  strategy.setCurrentTime(timestamp);
  strategy.updateMarketIndicators(indicators);
  
  // 3. Execute
  const result = strategy.execute();
  
  // 4. Log results
  if (result.action === "rebalance") {
    console.log(`[${timestamp}] ${result.message}`);
    const metrics = strategy.getPositionMetrics();
    logMetrics(metrics);
  }
}
```

---

## Configuration Reference

### Required Configuration

```typescript
{
  // Core settings
  segmentCount: 3,                    // Always 3 for V1.2
  segmentRangePercent: 0.175,         // Base range (7.5-35% based on volatility)
  
  // V1.2 specific
  maxDailyRebalances: 1,              // Max 1 rebalance per day
  minRebalanceCooldownMs: 600_000,    // 10 minutes cooldown
  
  // Position allocation (Option A)
  pos1AllocationPercent: 33.33,       // Position 1: 33.33%
  pos2AllocationPercent: 33.33,       // Position 2: 33.33%
  pos3AllocationPercent: 33.34,       // Position 3: 33.34%
  
  // Range multipliers (Option A)
  baseRangeMultiplier: 1.0,           // Position 1: base × 1.0
  mediumRangeMultiplier: 1.5,         // Position 2: base × 1.5
  wideRangeMultiplier: 2.0,           // Position 3: base × 2.0
  
  // Market indicators (will be updated at runtime)
  trendScore: 50,                     // Initial trend score
  safetyScore: 50,                    // Initial safety score
}
```

### Optional Configuration

```typescript
{
  // Timing
  fastIntervalMs: 600_000,            // Check interval (10 minutes)
  slowIntervalMs: 600_000,            // Slow check interval (10 minutes)
  minSegmentDwellMs: 120_000,         // Dwell time before rebalance (2 min)
  minOutOfRangeMs: 120_000,           // Wait time after out-of-range (2 min)
  
  // Slippage
  maxSwapSlippageBps: 50,             // Max slippage 0.5%
  bootstrapMaxSwapSlippageBps: 200,   // Bootstrap slippage 2%
  bootstrapAttempts: 3,               // Bootstrap attempts
  
  // Costs
  actionCostTokenA: 0,                // Cost in token A
  actionCostTokenB: 5000,             // Cost in token B (e.g., gas fees)
  
  // Enhanced features
  enableAdaptiveBandWidth: true,      // Use volatility-based ranges
  enableDynamicAllocation: false,     // V1.2 uses fixed allocation
  enableFeeCompounding: true,         // Auto-compound fees
}
```

---

## Testing Checklist

### Unit Tests
- [ ] Entry conditions (Safety Score, Trend Score)
- [ ] Volatility-based range selection
- [ ] Fee earned calculation
- [ ] Price loss calculation
- [ ] Swap fee estimation
- [ ] Rebalancing decision logic (Trend ≥60 vs <60)
- [ ] Farthest position selection
- [ ] Daily rebalance limit
- [ ] Cooldown period enforcement

### Integration Tests
- [ ] Position opening with entry conditions
- [ ] Contiguous band layout (no overlap)
- [ ] Equal capital allocation (33.33% each)
- [ ] Range multipliers (1.0, 1.5, 2.0)
- [ ] Rebalance only farthest position
- [ ] Market indicator updates
- [ ] Position metrics reporting

### Backtest Scenarios
- [ ] Bull market (Trend >70)
- [ ] Bear market (Trend <30)
- [ ] High volatility (>75%)
- [ ] Low volatility (<20%)
- [ ] Sideways market (Trend 45-55)
- [ ] Flash crash scenario

---

## Performance Metrics to Track

1. **Position Metrics**
   - In-range time percentage
   - Fee earned per position
   - Price loss per position
   - Rebalance frequency

2. **Strategy Metrics**
   - Total APR
   - Sharpe ratio
   - Max drawdown
   - Win rate (profitable rebalances / total rebalances)

3. **Cost Metrics**
   - Swap fees as % of fees earned
   - Action costs as % of profit
   - Gas fees (if applicable)

---

## Troubleshooting

### Issue: Positions not opening
**Check:**
- Safety Score ≥ 50?
- Trend Score ≥ 50?
- Sufficient capital?
- Volatility data available?

### Issue: No rebalancing happening
**Check:**
- Is any position out of range?
- Has minOutOfRangeMs elapsed?
- Daily rebalance limit reached?
- Cooldown period active?
- Profit condition met (fee > loss + swap)?

### Issue: Too many rebalances
**Check:**
- maxDailyRebalances set to 1?
- minRebalanceCooldownMs = 600_000 (10 min)?
- minSegmentDwellMs = 120_000 (2 min)?

---

## Migration from Previous Versions

### From v2.4.1 (Overlapping Bands)

**Changes needed:**
1. Update allocation: 60/20/20 → 33.33/33.33/33.34
2. Change layout: overlapping → contiguous
3. Update rebalancing: all 3 positions → only farthest
4. Add market indicators tracking
5. Implement profit-based rebalancing logic
6. Update monitoring interval: varies → 10 minutes

**Config migration:**
```typescript
// Old config (v2.4.1)
{
  pos1AllocationPercent: 60,
  pos2AllocationPercent: 20,
  pos3AllocationPercent: 20,
  fastIntervalMs: 30_000,
  maxDailyRebalances: 5,
}

// New config (V1.2)
{
  pos1AllocationPercent: 33.33,
  pos2AllocationPercent: 33.33,
  pos3AllocationPercent: 33.34,
  fastIntervalMs: 600_000,
  maxDailyRebalances: 1,
  trendScore: 50,
  safetyScore: 50,
}
```

---

## References

- **V_1.2.txt**: Strategy Version 1.2 Technical Implementation Plan
- **CHANGES_V1.2_OPTION_A.md**: Detailed change log
- **THREE_BAND_STRATEGY_GUIDE.md**: General strategy documentation

---

## Support

For questions or issues:
1. Check this guide first
2. Review V_1.2.txt specification
3. Examine code comments in the strategy file
4. Run unit tests to verify behavior

---

**Last Updated**: 2025-11-18  
**Implementation Version**: V1.2 Option A (Complete)
